#!/bin/bash

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÑ‚Ð°Ñ‚ÑƒÑÐ½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
print_status() {
    echo -e "\n\033[1;34m==>\033[0m $1"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ð± ÑƒÑÐ¿ÐµÑ…Ðµ
print_success() {
    echo -e "\033[1;32m[âœ“]\033[0m $1"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
print_error() {
    echo -e "\033[1;31m[âœ—]\033[0m $1" >&2
    exit 1
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ð¹
print_warning() {
    echo -e "\033[1;33m[!]\033[0m $1"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÐºÑ€Ð°ÑÐ¾Ñ‡Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ git pull
git_pull_with_style() {
    local repo_name=$(basename "$(git rev-parse --show-toplevel 2>/dev/null)" 2>/dev/null)
    local branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "unknown")
    
    print_status "ðŸ“¥ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ: \033[1;36m$repo_name\033[0m (Ð²ÐµÑ‚ÐºÐ°: \033[1;35m$branch\033[0m)"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
    if [ -n "$(git status --porcelain)" ]; then
        print_warning "Ð•ÑÑ‚ÑŒ Ð½ÐµÐ·Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:"
        git status --short
        echo
    fi
    
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ git pull Ñ Ñ†Ð²ÐµÑ‚Ð½Ñ‹Ð¼ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼
    print_status "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ git pull..."
    echo -e "\033[1;30mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
    
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ git pull Ð¸ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´
    local pull_output
    if pull_output=$(git pull 2>&1); then
        echo -e "\033[1;30mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
        
        # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ Ð´Ð»Ñ ÐºÑ€Ð°ÑÐ¸Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
        if echo "$pull_output" | grep -q "Already up to date"; then
            print_success "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑƒÐ¶Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÐµÐ½ âœ“"
        elif echo "$pull_output" | grep -q "Fast-forward"; then
            print_success "Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾! Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¿ÐµÑ€ÐµÐ¼Ð¾Ñ‚ÐºÐ° âœ“"
            echo -e "\033[1;32mÐ˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:\033[0m"
            echo "$pull_output" | grep -E "(create|delete|update)" | head -5
        else
            print_success "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ âœ“"
            echo -e "\033[1;32mÐ ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:\033[0m"
            echo "$pull_output" | tail -3
        fi
    else
        echo -e "\033[1;30mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
        print_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ git pull:"
        echo -e "\033[1;31m$pull_output\033[0m"
        return 1
    fi
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ
    print_status "Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ:"
    git status --short --branch | head -3
    echo
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒÑÑ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ src
process_src_directory() {
    print_status "=== ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ: \033[1;33m$(basename "$PWD")\033[0m ==="
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
    if [ ! -d .git ]; then
        print_warning "Ð­Ñ‚Ð¾ Ð½Ðµ git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼"
        return 0
    fi
    
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÑ€Ð°ÑÐ¾Ñ‡Ð½Ñ‹Ð¹ git pull
    git_pull_with_style
}


update_unitree_repos() {
    cd $UNITREE_REPOS_ROOT
    print_status "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $PWD"
    print_status "ÐŸÐ¾Ð¸ÑÐº Ð¿Ð°Ð¿Ð¾Ðº unitree_h1_*..."
    echo

    # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð²ÑÐµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸ Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ñ…
    while IFS= read -r -d $'\0' folder; do
        src_path="$folder/src"
        
        if [[ -d "$src_path" ]]; then
            print_status "ÐÐ°Ð¹Ð´ÐµÐ½Ð° Ð¿Ð°Ð¿ÐºÐ° src: $src_path"
            (
                cd "$src_path" || {
                    print_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð² $src_path" >&2
                    echo
                    exit 1
                }
                process_src_directory
            )
            echo
        else
            print_status "ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ $folder - Ð¿Ð°Ð¿ÐºÐ° src Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°" >&2
            echo
        fi
    done < <(find . -maxdepth 1 -type d -name "unitree_h1_*" -print0)

    print_success "ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²ÑÐµÑ… Ð¿Ð°Ð¿Ð¾Ðº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
}